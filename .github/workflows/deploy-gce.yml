name: Deploy to GCE

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main

env:
  REGISTRY_HOST: ${{ vars.REGISTRY_HOST }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY }}

jobs:
  deploy:
    name: Deploy to GCE
    runs-on: ubuntu-latest
    # Âè™Âú® CI/CD Pipeline ÊàêÂäü‰∏îÊòØ push to main Êàñ manual dispatch ÊôÇÂü∑Ë°å
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=production" >> $GITHUB_ENV
          fi
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure environment-specific variables
        run: |
          if [ "${{ env.DEPLOY_ENV }}" == "production" ]; then
            echo "GCE_INSTANCE=${{ vars.GCE_INSTANCE_PROD }}" >> $GITHUB_ENV
            echo "GCE_ZONE=${{ vars.GCE_ZONE_PROD }}" >> $GITHUB_ENV
          else
            echo "GCE_INSTANCE=${{ vars.GCE_INSTANCE_STAGING }}" >> $GITHUB_ENV
            echo "GCE_ZONE=${{ vars.GCE_ZONE_STAGING }}" >> $GITHUB_ENV
          fi

      - name: Deploy to GCE
        run: |
          echo "============================================"
          echo "üöÄ Deploying to GCE"
          echo "============================================"
          echo "Environment: ${{ env.DEPLOY_ENV }}"
          echo "Instance: ${{ env.GCE_INSTANCE }}"
          echo "Zone: ${{ env.GCE_ZONE }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "============================================"

          # SSH Âà∞ GCE ‰∏¶Âü∑Ë°åÈÉ®ÁΩ≤ËÖ≥Êú¨
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="bash -s" << 'ENDSSH'
              set -e

              echo "üì¶ Authenticating Docker with GAR..."
              gcloud auth configure-docker ${{ env.REGISTRY_HOST }} --quiet

              echo "üì• Pulling latest images..."
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-base:${{ env.IMAGE_TAG }}
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-api:${{ env.IMAGE_TAG }}
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-frontend:${{ env.IMAGE_TAG }}

              # Tag as latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-base:${{ env.IMAGE_TAG }} refactor-base:latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-api:${{ env.IMAGE_TAG }} refactor-api:latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-frontend:${{ env.IMAGE_TAG }} refactor-frontend:latest

              echo "üîÑ Updating services with docker-compose..."
              cd ~/auto-refactor-agent

              # ÂÅúÊ≠¢‰∏¶ÁßªÈô§ËàäÂÆπÂô®
              docker-compose -f devops/docker-compose.prod.yml down

              # ÂïüÂãïÊñ∞ÂÆπÂô®
              docker-compose -f devops/docker-compose.prod.yml up -d

              echo "üßπ Cleaning up old images..."
              docker image prune -f

              echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Health check
        run: |
          echo "üè• Running health check..."

          # ÂèñÂæó GCE Â§ñÈÉ® IP
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')

          echo "Instance IP: $EXTERNAL_IP"

          # Á≠âÂæÖÊúçÂãôÂïüÂãï
          sleep 30

          # Ê™¢Êü• API ÂÅ•Â∫∑ÁãÄÊÖã
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "http://${EXTERNAL_IP}:8000/health" > /dev/null; then
              echo "‚úÖ API is healthy!"
              break
            else
              echo "‚è≥ Waiting for API to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 10
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

          # Ê™¢Êü• Frontend
          if curl -f -s "http://${EXTERNAL_IP}:80" > /dev/null; then
            echo "‚úÖ Frontend is accessible!"
          else
            echo "‚ö†Ô∏è Frontend health check failed"
          fi

      - name: Deployment summary
        run: |
          echo "============================================"
          echo "‚úÖ Deployment Summary"
          echo "============================================"
          echo "Environment: ${{ env.DEPLOY_ENV }}"
          echo "Instance: ${{ env.GCE_INSTANCE }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "Deployed Images:"
          echo "  - refactor-base:${{ env.IMAGE_TAG }}"
          echo "  - refactor-api:${{ env.IMAGE_TAG }}"
          echo "  - refactor-frontend:${{ env.IMAGE_TAG }}"
          echo "============================================"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs and GCE instance status."
