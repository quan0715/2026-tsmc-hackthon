name: Deploy to GCE

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main

env:
  REGISTRY_HOST: ${{ vars.REGISTRY_HOST }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY }}
  # Optional. If set, deploy will run as this OS user on the VM (avoids defaulting to "runner").
  GCE_SSH_USER: ${{ vars.GCE_SSH_USER }}
  # Optional. Absolute path recommended, e.g. /opt/auto-refactor-agent
  GCE_APP_DIR: ${{ vars.GCE_APP_DIR }}
  # Prevent gcloud from prompting (important because we use heredoc stdin for the remote script).
  CLOUDSDK_CORE_DISABLE_PROMPTS: "1"

jobs:
  deploy:
    name: Deploy to GCE
    runs-on: ubuntu-latest
    # Âè™Âú® CI/CD Pipeline ÊàêÂäü‰∏îÊòØ push to main Êàñ manual dispatch ÊôÇÂü∑Ë°å
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "GCE_INSTANCE=${{ vars.GCE_INSTANCE }}" >> $GITHUB_ENV
          echo "GCE_ZONE=${{ vars.GCE_ZONE }}" >> $GITHUB_ENV
          echo "GCE_SSH_USER=${{ vars.GCE_SSH_USER }}" >> $GITHUB_ENV
          echo "GCE_APP_DIR=${{ vars.GCE_APP_DIR }}" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Prepare SSH for gcloud (non-interactive)
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # gcloud compute ssh defaults to ~/.ssh/google_compute_engine
          if [ ! -f ~/.ssh/google_compute_engine ]; then
            ssh-keygen -t rsa -b 3072 -f ~/.ssh/google_compute_engine -N "" -C "gha-${GITHUB_RUN_ID}"
          fi

          chmod 600 ~/.ssh/google_compute_engine
          chmod 644 ~/.ssh/google_compute_engine.pub

      - name: Deploy to GCE
        run: |
          set -euo pipefail

          echo "============================================"
          echo "üöÄ Deploying to GCE"
          echo "============================================"
          echo "Instance: ${{ env.GCE_INSTANCE }}"
          echo "Zone: ${{ env.GCE_ZONE }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "============================================"

          SSH_TARGET="${{ env.GCE_INSTANCE }}"
          if [ -n "${GCE_SSH_USER:-}" ]; then
            SSH_TARGET="${GCE_SSH_USER}@${{ env.GCE_INSTANCE }}"
          fi

          # SSH Âà∞ GCE ‰∏¶Âü∑Ë°åÈÉ®ÁΩ≤ËÖ≥Êú¨
          gcloud compute ssh "$SSH_TARGET" \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet \
            --ssh-flag="-o BatchMode=yes" \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            --ssh-flag="-o UserKnownHostsFile=/dev/null" \
            --command="bash -s" << 'ENDSSH'
              set -euo pipefail

              APP_DIR="${{ env.GCE_APP_DIR }}"
              if [ -z "$APP_DIR" ]; then
                APP_DIR="$HOME/auto-refactor-agent"
              fi

              echo "üì¶ Authenticating Docker with GAR..."
              gcloud auth configure-docker ${{ env.REGISTRY_HOST }} --quiet

              echo "üì• Pulling latest images..."
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-base:${{ env.IMAGE_TAG }}
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-api:${{ env.IMAGE_TAG }}
              docker pull ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-frontend:${{ env.IMAGE_TAG }}

              # Tag as latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-base:${{ env.IMAGE_TAG }} refactor-base:latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-api:${{ env.IMAGE_TAG }} refactor-api:latest
              docker tag ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/refactor-frontend:${{ env.IMAGE_TAG }} refactor-frontend:latest

              echo "üîÑ Updating services with docker-compose..."
              if [ ! -d "$APP_DIR" ]; then
                echo "‚ùå App directory not found: $APP_DIR"
                echo "Remote user: $(whoami)"
                echo "Remote home: $HOME"
                echo "Hint: set GitHub variable GCE_APP_DIR (recommended absolute path), or GCE_SSH_USER to the VM user that owns the repo."
                ls -la "$HOME" || true
                ls -la /home || true
                exit 1
              fi

              cd "$APP_DIR"

              if [ ! -f devops/docker-compose.prod.yml ]; then
                echo "‚ùå Missing devops/docker-compose.prod.yml under ~/auto-refactor-agent"
                exit 1
              fi

              compose() {
                if command -v docker-compose >/dev/null 2>&1; then
                  docker-compose "$@"
                  return
                fi
                docker compose "$@"
              }

              # ÂÅúÊ≠¢‰∏¶ÁßªÈô§ËàäÂÆπÂô®
              compose -f devops/docker-compose.prod.yml down

              # ÂïüÂãïÊñ∞ÂÆπÂô®
              compose -f devops/docker-compose.prod.yml up -d

              echo "üßπ Cleaning up old images..."
              docker image prune -f

              echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Health check
        run: |
          echo "üè• Running health check..."

          # ÂèñÂæó GCE Â§ñÈÉ® IP
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')

          echo "Instance IP: $EXTERNAL_IP"

          # Á≠âÂæÖÊúçÂãôÂïüÂãï
          sleep 30

          # Ê™¢Êü• API ÂÅ•Â∫∑ÁãÄÊÖã
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "http://${EXTERNAL_IP}:8000/health" > /dev/null; then
              echo "‚úÖ API is healthy!"
              break
            else
              echo "‚è≥ Waiting for API to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 10
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

          # Ê™¢Êü• Frontend
          if curl -f -s "http://${EXTERNAL_IP}:80" > /dev/null; then
            echo "‚úÖ Frontend is accessible!"
          else
            echo "‚ö†Ô∏è Frontend health check failed"
          fi

      - name: Deployment summary
        run: |
          echo "============================================"
          echo "‚úÖ Deployment Summary"
          echo "============================================"
          echo "Instance: ${{ env.GCE_INSTANCE }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "Deployed Images:"
          echo "  - refactor-base:${{ env.IMAGE_TAG }}"
          echo "  - refactor-api:${{ env.IMAGE_TAG }}"
          echo "  - refactor-frontend:${{ env.IMAGE_TAG }}"
          echo "============================================"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs and GCE instance status."
