# CLI 主選單模式使用指南 📋

## 概述

CLI 工具現在提供完整的互動式主選單，就像小型前端一樣，可以管理專案的完整生命週期。

## 啟動方式

```bash
python3 cli.py
```

## 登入

按 Enter 使用預設測試帳號：
- Email: `test@example.com`
- Password: `testpass123`

## 主選單功能

```
╔═══════════════════════════════════════════════════════════╗
║                    主選單                                 ║
╠═══════════════════════════════════════════════════════════╣
║  專案管理                                                 ║
║    1. 📋 列出所有專案                                     ║
║    2. ➕ 建立新專案                                       ║
║    3. 🗑️  刪除專案                                        ║
║                                                           ║
║  容器管理                                                 ║
║    4. 🚀 Provision 專案（建立容器）                       ║
║    5. ⏹️  停止專案容器                                    ║
║                                                           ║
║  Agent 執行                                               ║
║    6. 🤖 執行 AI Agent                                    ║
║    7. 📊 串流日誌                                         ║
║    8. 📈 查詢 Agent 狀態                                  ║
║                                                           ║
║    0. 👋 登出/退出                                        ║
╚═══════════════════════════════════════════════════════════╝
```

## 功能詳解

### 1. 📋 列出所有專案

顯示所有專案並可選擇設定為「當前專案」。

**操作流程**：
1. 選擇功能 `1`
2. 查看專案列表
3. 輸入專案編號設定為當前專案，或按 Enter 返回

**範例輸出**：
```
專案列表 (共 2 個)

1. [abc12345] Racing-Car-Katas
   狀態: READY
   Repository: https://github.com/emilybache/Racing-Car-Katas.git

2. [def67890] Hello-World
   狀態: CREATED
   Repository: https://github.com/octocat/Hello-World.git

選擇專案編號（設為當前專案）或按 Enter 返回: 1
✅ 已設定當前專案: Racing-Car-Katas (ID: abc12345...)
```

---

### 2. ➕ 建立新專案

建立新的程式碼重構專案。

**操作流程**：
1. 選擇功能 `2`
2. 按 Enter 使用預設測試專案，或輸入 `n` 自訂
3. 專案建立後自動設為當前專案

**預設測試專案**：
- Repository: `https://github.com/octocat/Hello-World.git`
- Branch: `main`

---

### 3. 🗑️ 刪除專案

刪除專案及其容器。

**操作流程**：
1. 選擇功能 `3`
2. 查看專案列表
3. 輸入要刪除的專案編號
4. 輸入 `yes` 確認刪除

**安全機制**：
- 需要明確輸入 `yes` 確認
- 會同時刪除專案和容器
- 如果刪除的是當前專案，會自動清除當前專案設定

---

### 4. 🚀 Provision 專案（建立容器）

為選定的專案建立 Docker 容器並 clone repository。

**前置條件**：
- 必須先選擇當前專案（功能 1）
- 專案狀態必須為 `CREATED` 或 `STOPPED`

**操作流程**：
1. 選擇功能 `4`
2. 系統自動建立容器
3. Clone repository 到容器
4. 專案狀態變為 `READY`

**重新 Provision**：
- 停止的專案（狀態 `STOPPED`）可以重新 provision
- 系統會自動清理舊容器並建立新容器
- 適用於需要重新啟動專案的情況

**開發模式**：
- 自動使用 `.env` 中的 `DEV_MODE` 設定
- 無需手動選擇

---

### 5. ⏹️ 停止專案容器

停止正在運行的專案容器。

**前置條件**：
- 必須先選擇當前專案（功能 1）

**使用情境**：
- 釋放系統資源
- 重新 provision 前先停止
- 暫停專案開發

---

### 6. 🤖 執行 AI Agent

啟動 AI Agent 分析程式碼並生成重構計劃。

**前置條件**：
- 專案狀態必須為 `READY`（已 provision）

**操作流程**：
1. 選擇功能 `6`
2. Agent 在背景執行
3. 取得 Run ID
4. 可使用功能 7 查看即時日誌

**輸出**：
```
✅ Agent 已啟動！
ℹ️  Run ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
ℹ️  狀態: RUNNING
💡 可使用功能 7 串流日誌
```

---

### 7. 📊 串流日誌

即時查看 Agent 執行日誌。

**前置條件**：
- 必須先選擇當前專案（功能 1）

**操作流程**：
1. 選擇功能 `7`
2. 輸入 Run ID，或按 Enter 使用最新的
3. 觀看即時日誌
4. 按 `Ctrl+C` 停止串流

**日誌範例**：
```
開始串流日誌 (Run ID: a1b2c3d4...)
ℹ️  按 Ctrl+C 停止串流

[2026-02-02T12:34:56] 🚀 開始執行 Agent
[2026-02-02T12:34:57] 🔧 初始化 LLM...
[2026-02-02T12:34:58] ✅ LLM 初始化完成
[2026-02-02T12:34:59] 🤖 建立 RefactorAgent...
[2026-02-02T12:35:00] ✅ RefactorAgent 建立完成
[2026-02-02T12:35:01] ▶️  執行 Agent...
[2026-02-02T12:35:05] 💬 AI Response: 我將分析專案結構...
```

---

### 8. 📈 查詢 Agent 狀態

查詢特定 Agent Run 的執行狀態。

**前置條件**：
- 必須先選擇當前專案（功能 1）

**操作流程**：
1. 選擇功能 `8`
2. 輸入 Run ID
3. 查看詳細狀態

**輸出範例**：
```
Agent 狀態 (Run ID: a1b2c3d4...)

狀態: SUCCESS
建立時間: 2026-02-02T12:34:56
開始時間: 2026-02-02T12:34:56
結束時間: 2026-02-02T12:40:00
```

---

## 典型使用流程

### 流程 1: 快速測試（使用預設專案）

```
1. 啟動 CLI
2. 按 Enter 登入（預設帳號）
3. 選擇 2 → 按 Enter（建立預設專案）
4. 選擇 4（Provision）
5. 選擇 6（執行 Agent）
6. 選擇 7 → 按 Enter（串流最新日誌）
7. 觀看執行過程
8. 選擇 0（退出）
```

### 流程 2: 管理多個專案

```
1. 登入
2. 選擇 1（查看所有專案）
3. 輸入編號選擇專案 A
4. 選擇 6（執行 Agent）
5. 選擇 1（切換專案）
6. 輸入編號選擇專案 B
7. 選擇 7（查看專案 B 的日誌）
```

### 流程 3: 專案清理

```
1. 登入
2. 選擇 1（查看所有專案）
3. 選擇 5（停止不需要的容器）
4. 選擇 3（刪除專案）
5. 輸入編號 → 輸入 yes 確認
```

---

## 快捷鍵

- **Enter**: 返回主選單或使用預設值
- **Ctrl+C**: 中斷當前操作（串流日誌）
- **0**: 退出程式

---

## 提示與技巧

### 💡 當前專案機制

- 大部分操作需要先選擇「當前專案」
- 使用功能 1 可以隨時切換當前專案
- 當前專案 ID 會顯示在選單下方

### 💡 自動使用最新 Run

- 功能 7（串流日誌）支援按 Enter 自動使用最新的 Run ID
- 不需要記住或複製 Run ID

### 💡 錯誤處理

- 所有錯誤都會有清楚的訊息提示
- 按 Enter 返回主選單繼續操作
- Ctrl+C 可中斷任何操作

### 💡 循環使用

- 主選單會持續顯示，直到選擇 0 退出
- 完成一個操作後按 Enter 返回主選單
- 可以連續執行多個操作

---

## 常見問題

### Q: 如何知道當前選擇了哪個專案？

A: 每次顯示主選單時，會在下方顯示：
```
ℹ️  當前專案: abc12345...
```

### Q: 可以同時執行多個 Agent 嗎？

A: 可以！在不同專案上執行功能 6 即可。使用功能 1 切換專案。

### Q: 如何查看歷史 Run？

A: 功能 8 可以查詢任何 Run ID 的狀態。Run ID 會在執行 Agent 時顯示。

### Q: 刪除專案會刪除容器嗎？

A: 是的，功能 3 會同時刪除專案和其容器。

### Q: 停止容器後專案還在嗎？

A: 是的，功能 5 只停止容器，不刪除專案。

**重新啟動方式**：
1. 選擇功能 1（列出專案），選擇已停止的專案
2. 選擇功能 4（Provision），系統會自動清理舊容器並建立新容器
3. 專案狀態會從 `STOPPED` 變回 `READY`

---

## 開發模式

如果要使用開發模式（動態掛載 agent 程式碼）：

1. 編輯 `backend/.env`
   ```bash
   DEV_MODE=true
   AGENT_HOST_PATH=/Users/quan/auto-refactor-agent/agent
   ```

2. 重啟 Backend

3. 使用功能 4 Provision 專案（自動使用開發模式）

---

## 結語

CLI 現在提供完整的專案管理功能，就像一個輕量級的前端介面。你可以：

✅ 管理多個專案
✅ 隨時啟動/停止容器
✅ 執行和監控 AI Agent
✅ 查看即時日誌
✅ 清理不需要的專案

享受使用！🚀
