# CLI å·¥å…·ä½¿ç”¨æŒ‡å—

## ç°¡ä»‹

`cli.py` æ˜¯ä¸€å€‹ç°¡æ˜“çš„å‘½ä»¤åˆ—å·¥å…·ï¼Œç”¨æ–¼æ¸¬è©¦ AI èˆŠç¨‹å¼ç¢¼æ™ºèƒ½é‡æ§‹ç³»çµ±çš„ API åŠŸèƒ½ï¼Œæš«æ™‚å–ä»£å‰ç«¯ä»‹é¢ã€‚

## å¿«é€Ÿé–‹å§‹ âš¡

**æœ€ç°¡å–®çš„ä½¿ç”¨æ–¹å¼**ï¼ˆå…¨éƒ¨ä½¿ç”¨é è¨­å€¼ï¼‰ï¼š

1. å•Ÿå‹• Backend å’Œ MongoDB
2. åŸ·è¡Œ `python3 cli.py`
3. é€£çºŒæŒ‰ **4 æ¬¡ Enter**ï¼š
   - ç¬¬ 1 æ¬¡ï¼šä½¿ç”¨é è¨­æ¸¬è©¦å¸³è™Ÿç™»å…¥
   - ç¬¬ 2 æ¬¡ï¼šä½¿ç”¨é è¨­æ¸¬è©¦å°ˆæ¡ˆ
   - ç¬¬ 3 æ¬¡ï¼šä½¿ç”¨é è¨­ dev_mode è¨­å®š
   - ç¬¬ 4 æ¬¡ï¼šï¼ˆå¦‚æœéœ€è¦è·³éæŸäº›æ­¥é©Ÿï¼‰

å°±é€™éº¼ç°¡å–®ï¼ç³»çµ±æœƒè‡ªå‹•ï¼š
- ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ `test@example.com`
- å»ºç«‹æ¸¬è©¦å°ˆæ¡ˆï¼ˆGitHub å®˜æ–¹ç¯„ä¾‹ï¼‰
- Provision å®¹å™¨
- åŸ·è¡Œ Agent
- é¡¯ç¤ºå³æ™‚æ—¥èªŒ

## åŠŸèƒ½

- âœ… ä½¿ç”¨è€…è¨»å†Š/ç™»å…¥
- âœ… å»ºç«‹å°ˆæ¡ˆ
- âœ… åˆ—å‡ºæ‰€æœ‰å°ˆæ¡ˆ
- âœ… Provision å°ˆæ¡ˆï¼ˆå»ºç«‹å®¹å™¨ã€clone repositoryï¼‰
- âœ… åŸ·è¡Œ AI Agent
- âœ… å³æ™‚ä¸²æµæ—¥èªŒ
- âœ… æŸ¥è©¢ Agent åŸ·è¡Œç‹€æ…‹

## ä½¿ç”¨æ–¹å¼

### å‰ç½®éœ€æ±‚

1. Backend API æ­£åœ¨é‹è¡Œ
   ```bash
   cd backend
   source venv/bin/activate
   uvicorn app.main:app --reload
   ```

2. MongoDB æ­£åœ¨é‹è¡Œ
   ```bash
   docker run -d --name mongodb -p 27017:27017 mongo:7
   ```

3. Docker åŸºç¤æ˜ åƒå·²å»ºç«‹
   ```bash
   docker build -t refactor-base:latest -f devops/base-image/Dockerfile .
   ```

### å•Ÿå‹• CLIï¼ˆäº’å‹•æ¨¡å¼ï¼‰

```bash
python3 cli.py
```

### äº’å‹•æµç¨‹

#### æ­¥é©Ÿ 1: ç™»å…¥/è¨»å†Š

**å¿«é€Ÿé–‹å§‹ï¼ˆä½¿ç”¨é è¨­æ¸¬è©¦å¸³è™Ÿï¼‰**ï¼š
```
è«‹é¸æ“‡ (1=ç™»å…¥, 2=è¨»å†Š, d=ä½¿ç”¨é è¨­å¸³è™Ÿç™»å…¥, Enter=ä½¿ç”¨é è¨­å¸³è™Ÿç™»å…¥):
â„¹ï¸  ä½¿ç”¨é è¨­å¸³è™Ÿ: test@example.com
âœ… è¨»å†ŠæˆåŠŸï¼ä½¿ç”¨è€…: test@example.com (test)
æˆ–
âœ… ç™»å…¥æˆåŠŸï¼ä½¿ç”¨è€…: test@example.com
```
> ğŸ’¡ ç›´æ¥æŒ‰ Enter å³å¯ä½¿ç”¨é è¨­æ¸¬è©¦å¸³è™Ÿ
> - Email: `test@example.com`
> - Username: `test` (è‡ªå‹•ç”Ÿæˆ)
> - Password: `testpass123`
>
> å¦‚æœå¸³è™Ÿä¸å­˜åœ¨æœƒè‡ªå‹•è¨»å†Šï¼

**è‡ªè¨‚å¸³è™Ÿ**ï¼š
```
è«‹é¸æ“‡ (1=ç™»å…¥, 2=è¨»å†Š, d=ä½¿ç”¨é è¨­å¸³è™Ÿç™»å…¥, Enter=ä½¿ç”¨é è¨­å¸³è™Ÿç™»å…¥): 2
Email (Enter=ä½¿ç”¨é è¨­): mytest@example.com
Password (Enter=ä½¿ç”¨é è¨­): mypassword
âœ… è¨»å†ŠæˆåŠŸï¼ä½¿ç”¨è€…: mytest@example.com
```

#### æ­¥é©Ÿ 2: é¸æ“‡æˆ–å»ºç«‹å°ˆæ¡ˆ

**ä½¿ç”¨é è¨­æ¸¬è©¦å°ˆæ¡ˆ**ï¼š
```
ä½¿ç”¨ç¾æœ‰å°ˆæ¡ˆ (è¼¸å…¥ç·¨è™Ÿ) æˆ–å»ºç«‹æ–°å°ˆæ¡ˆ (è¼¸å…¥ n): n

å»ºç«‹æ–°å°ˆæ¡ˆ
â„¹ï¸  é è¨­æ¸¬è©¦ Repository: https://github.com/octocat/Hello-World.git
æ˜¯å¦ä½¿ç”¨é è¨­æ¸¬è©¦å°ˆæ¡ˆï¼Ÿ(Enter=æ˜¯, n=è‡ªè¨‚):
âœ… ä½¿ç”¨é è¨­å°ˆæ¡ˆ: æ¸¬è©¦å°ˆæ¡ˆ
âœ… å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼ID: 507f1f77bcf86cd799439011
```
> ğŸ’¡ ç›´æ¥æŒ‰ Enter å³å¯ä½¿ç”¨é è¨­æ¸¬è©¦å°ˆæ¡ˆï¼ˆGitHub å®˜æ–¹ç¯„ä¾‹ repositoryï¼‰

**é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ**ï¼š
```
å°ˆæ¡ˆåˆ—è¡¨ (å…± 2 å€‹)
1. [abc12345] æ¸¬è©¦å°ˆæ¡ˆ
   ç‹€æ…‹: READY
   Repository: https://github.com/octocat/Hello-World.git

2. [def67890] æˆ‘çš„å°ˆæ¡ˆ
   ç‹€æ…‹: CREATED
   Repository: https://github.com/user/my-repo.git

ä½¿ç”¨ç¾æœ‰å°ˆæ¡ˆ (è¼¸å…¥ç·¨è™Ÿ) æˆ–å»ºç«‹æ–°å°ˆæ¡ˆ (è¼¸å…¥ n): 1
âœ… å·²é¸æ“‡å°ˆæ¡ˆ: æ¸¬è©¦å°ˆæ¡ˆ
```

**è‡ªè¨‚å°ˆæ¡ˆ**ï¼š
```
æ˜¯å¦ä½¿ç”¨é è¨­æ¸¬è©¦å°ˆæ¡ˆï¼Ÿ(Enter=æ˜¯, n=è‡ªè¨‚): n
å°ˆæ¡ˆåç¨±: My Custom Project
Repository URL: https://github.com/user/repo.git
Branch (é è¨­ main): main
åˆå§‹æç¤ºè© (Enter=ä½¿ç”¨é è¨­):
âœ… å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼ID: 507f1f77bcf86cd799439011
```

#### æ­¥é©Ÿ 3: Provision å°ˆæ¡ˆ
```
æ­¥é©Ÿ 3: Provision å°ˆæ¡ˆ
â„¹ï¸  å°ˆæ¡ˆå°šæœª provisionï¼Œéœ€è¦å»ºç«‹å®¹å™¨ä¸¦ clone repository
æ˜¯å¦å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼Ÿ(Enter=ä½¿ç”¨å…¨åŸŸè¨­å®š, y=æ˜¯, n=å¦):
âœ… Provision æˆåŠŸï¼
â„¹ï¸  Container ID: abc123def456
â„¹ï¸  ç‹€æ…‹: READY
```
> ğŸ’¡ ç›´æ¥æŒ‰ Enter ä½¿ç”¨ `.env` ä¸­çš„ `DEV_MODE` è¨­å®š

#### æ­¥é©Ÿ 4: åŸ·è¡Œ Agent
```
âœ… Agent å·²å•Ÿå‹•ï¼
â„¹ï¸  Run ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
â„¹ï¸  ç‹€æ…‹: pending
```

#### æ­¥é©Ÿ 5: ä¸²æµæ—¥èªŒ
```
é–‹å§‹ä¸²æµæ—¥èªŒ (Run ID: a1b2c3d4...)
â„¹ï¸  æŒ‰ Ctrl+C åœæ­¢ä¸²æµ

[2026-02-02T12:34:56] ğŸš€ é–‹å§‹åŸ·è¡Œ Agent
[2026-02-02T12:34:57] ğŸ”§ åˆå§‹åŒ– LLM...
[2026-02-02T12:34:58] âœ… LLM åˆå§‹åŒ–å®Œæˆ
[2026-02-02T12:34:59] ğŸ¤– å»ºç«‹ RefactorAgent...
[2026-02-02T12:35:00] âœ… RefactorAgent å»ºç«‹å®Œæˆ
[2026-02-02T12:35:01] â–¶ï¸  åŸ·è¡Œ Agent...
[2026-02-02T12:35:02] ğŸ“ User Message: è«‹åˆ†æå°ˆæ¡ˆçµæ§‹...
[2026-02-02T12:35:05] ğŸ’¬ AI Response: æˆ‘å°‡å¹«æ‚¨åˆ†æå°ˆæ¡ˆçµæ§‹...
...
[2026-02-02T12:40:00] âœ… Agent åŸ·è¡Œå®Œæˆ

âœ… æ—¥èªŒä¸²æµçµæŸ
```

#### æ­¥é©Ÿ 6: æŸ¥è©¢æœ€çµ‚ç‹€æ…‹
```
ç‹€æ…‹: SUCCESS
å»ºç«‹æ™‚é–“: 2026-02-02T12:34:56
é–‹å§‹æ™‚é–“: 2026-02-02T12:34:56
çµæŸæ™‚é–“: 2026-02-02T12:40:00
```

## é–‹ç™¼æ¨¡å¼èªªæ˜

åœ¨ Provision éšæ®µå¯ä»¥é¸æ“‡æ˜¯å¦å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼š

- **y (æ˜¯)**: å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼Œagent ç¨‹å¼ç¢¼å¾æœ¬æ©Ÿå‹•æ…‹æ›è¼‰ï¼Œä¿®æ”¹å³ç”Ÿæ•ˆ
- **n (å¦)**: åœç”¨é–‹ç™¼æ¨¡å¼ï¼Œä½¿ç”¨ Docker image å…§å»ºçš„ agent
- **é è¨­ (ç›´æ¥ Enter)**: ä½¿ç”¨ `.env` ä¸­çš„ `DEV_MODE` è¨­å®š

### é–‹ç™¼æ¨¡å¼å‰ç½®è¨­å®š

å¦‚æœè¦ä½¿ç”¨é–‹ç™¼æ¨¡å¼ï¼Œè«‹å…ˆåœ¨ `backend/.env` è¨­å®šï¼š

```bash
DEV_MODE=true
AGENT_HOST_PATH=/Users/quan/auto-refactor-agent/agent
```

## å¸¸è¦‹å•é¡Œ

### 1. é€£ç·šéŒ¯èª¤
```
âŒ ç™»å…¥éŒ¯èª¤: ConnectError
```
**è§£æ±ºæ–¹æ³•**: ç¢ºèª Backend API æ­£åœ¨é‹è¡Œï¼ˆé è¨­ `http://localhost:8000`ï¼‰

### 2. èªè­‰å¤±æ•—
```
âŒ ç™»å…¥å¤±æ•—: {"detail":"Invalid credentials"}
```
**è§£æ±ºæ–¹æ³•**: æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–é‡æ–°è¨»å†Š

### 3. Provision è¶…æ™‚
```
âŒ Provision éŒ¯èª¤: timeout
```
**è§£æ±ºæ–¹æ³•**:
- æª¢æŸ¥ Docker æ˜¯å¦æ­£å¸¸é‹è¡Œ
- ç¢ºèª `refactor-base:latest` image å·²å»ºç«‹
- æª¢æŸ¥ç¶²è·¯é€£ç·šï¼ˆclone repository éœ€è¦ç¶²è·¯ï¼‰

### 4. Agent å•Ÿå‹•å¤±æ•—
```
âŒ å•Ÿå‹• Agent å¤±æ•—: {"detail":"å°ˆæ¡ˆç‹€æ…‹å¿…é ˆç‚º READY"}
```
**è§£æ±ºæ–¹æ³•**: å…ˆåŸ·è¡Œ Provision æ­¥é©Ÿ

### 5. æ—¥èªŒä¸²æµç„¡è³‡æ–™
```
é–‹å§‹ä¸²æµæ—¥èªŒ...
(æ²’æœ‰ä»»ä½•è¼¸å‡º)
```
**å¯èƒ½åŸå› **:
- Agent å°šæœªé–‹å§‹åŸ·è¡Œï¼ˆç­‰å¾…å¹¾ç§’ï¼‰
- å®¹å™¨å…§ AI Server æœªæ­£ç¢ºå•Ÿå‹•
- æ—¥èªŒè¼¸å‡ºè¢«ç·©è¡ï¼ˆå·²åœ¨æœ¬æ¬¡æ›´æ–°ä¸­ä¿®å¾©ï¼‰

**Debug æ–¹æ³•**:
```bash
# æª¢æŸ¥å®¹å™¨æ˜¯å¦é‹è¡Œ
docker ps | grep refactor-project

# æŸ¥çœ‹å®¹å™¨æ—¥èªŒ
docker logs refactor-project-{project_id}

# æª¢æŸ¥å®¹å™¨å…§ AI Server
docker exec refactor-project-{project_id} ps aux | grep uvicorn
```

## é€²éšç”¨æ³•

### ä¿®æ”¹ API Base URL

å¦‚æœ Backend API ä¸åœ¨ `localhost:8000`ï¼Œå¯ä»¥ä¿®æ”¹ `cli.py`:

```python
cli = RefactorCLI(api_base_url="http://your-server:8000")
```

### è‡ªå‹•åŒ–è…³æœ¬

CLI ä¹Ÿå¯ç”¨æ–¼è‡ªå‹•åŒ–æ¸¬è©¦ï¼š

```python
from cli import RefactorCLI
import asyncio

async def automated_test():
    cli = RefactorCLI()

    # ç™»å…¥
    await cli.login("test@example.com", "testpass123")

    # å»ºç«‹å°ˆæ¡ˆ
    project_id = await cli.create_project(
        name="Auto Test",
        repo_url="https://github.com/user/repo.git"
    )

    # Provision
    await cli.provision_project(project_id)

    # åŸ·è¡Œ Agent
    run_id = await cli.run_agent(project_id)

    # ä¸²æµæ—¥èªŒ
    await cli.stream_logs(project_id, run_id)

asyncio.run(automated_test())
```

## ä¸‹ä¸€æ­¥

- [ ] å¢åŠ ä¸‹è¼‰ artifacts åŠŸèƒ½
- [ ] å¢åŠ å°ˆæ¡ˆåˆªé™¤åŠŸèƒ½
- [ ] æ”¯æ´å‘½ä»¤åˆ—åƒæ•¸æ¨¡å¼ï¼ˆéäº’å‹•ï¼‰
- [ ] å¢åŠ å½©è‰²è¼¸å‡º
- [ ] å¢åŠ é€²åº¦æ¢

## å›é¥‹

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹åœ¨ GitHub Issues å›å ±ã€‚
