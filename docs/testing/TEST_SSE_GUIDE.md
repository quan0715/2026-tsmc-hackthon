# SSE Stream æ¸¬è©¦æŒ‡å—

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

æ¸¬è©¦å¾Œç«¯èƒ½å¦æ­£ç¢ºæ¥æ”¶ä¸¦è½‰ç™¼ AI Server çš„ SSE äº‹ä»¶ã€‚

## ğŸ“‹ å‰ç½®æº–å‚™

### 1. ç¢ºä¿æœå‹™é‹è¡Œ

```bash
# Terminal 1: å•Ÿå‹• MongoDB
docker run -d --name mongodb -p 27017:27017 mongo:7

# Terminal 2: å•Ÿå‹•å¾Œç«¯ API
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --port 8000

# Terminal 3: å»ºç«‹ base image
cd /Users/quan/auto-refactor-agent
docker build -t refactor-base:latest -f devops/base-image/Dockerfile .
```

### 2. æº–å‚™æ¸¬è©¦å°ˆæ¡ˆ

```bash
# ä½¿ç”¨å‰ç«¯æˆ– API å»ºç«‹ä¸€å€‹å°ˆæ¡ˆ
# ç¢ºä¿å°ˆæ¡ˆç‹€æ…‹ç‚º READYï¼ˆå·² provisionï¼‰
```

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

```bash
# å®‰è£ä¾è³´ï¼ˆå¦‚æœé‚„æ²’å®‰è£ï¼‰
pip install httpx

# åŸ·è¡Œæ¸¬è©¦è…³æœ¬
python test_sse_stream.py
```

## ğŸ“ æ¸¬è©¦æµç¨‹

è…³æœ¬æœƒå¼•å°ä½ å®Œæˆä»¥ä¸‹æ­¥é©Ÿï¼š

1. **ç™»å…¥**ï¼šè¼¸å…¥ email å’Œ passwordï¼ˆæˆ–ä½¿ç”¨é è¨­æ¸¬è©¦å¸³è™Ÿï¼‰
2. **é¸æ“‡å°ˆæ¡ˆ**ï¼šå¾å°ˆæ¡ˆåˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹
3. **å•Ÿå‹•æˆ–ä½¿ç”¨ç¾æœ‰ Run**ï¼š
   - è¼¸å…¥ `y` å•Ÿå‹•æ–°çš„ Agent Run
   - è¼¸å…¥ `n` å–æ¶ˆ
   - è¼¸å…¥ run_id ä½¿ç”¨ç¾æœ‰çš„ run
4. **è§€å¯Ÿ SSE äº‹ä»¶**ï¼šè…³æœ¬æœƒå³æ™‚é¡¯ç¤ºæ¥æ”¶åˆ°çš„äº‹ä»¶
5. **æª¢æŸ¥æœ€çµ‚ç‹€æ…‹**ï¼šä¸²æµçµæŸå¾Œæœƒé¡¯ç¤º Agent çš„æœ€çµ‚ç‹€æ…‹

## ğŸ” é æœŸçœ‹åˆ°çš„è¼¸å‡º

### æ­£å¸¸æƒ…æ³ï¼š

```
[10:30:45.123] ğŸ“¡ é–‹å§‹æ¸¬è©¦ SSE ä¸²æµ...
============================================================
é–‹å§‹æ¥æ”¶ SSE äº‹ä»¶ï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰ï¼š
============================================================

[10:30:45.234] ğŸ“¨ äº‹ä»¶é¡å‹: event: log
[10:30:45.235] ğŸ“„ è³‡æ–™: data: 2024-02-02T10:30:45.000Z é–‹å§‹åŸ·è¡Œ Agent
[10:30:46.100] ğŸ“¨ äº‹ä»¶é¡å‹: event: log
[10:30:46.101] ğŸ“„ è³‡æ–™: data: 2024-02-02T10:30:46.000Z åˆå§‹åŒ– LLM...
[10:30:47.200] ğŸ“¨ äº‹ä»¶é¡å‹: event: log
[10:30:47.201] ğŸ“„ è³‡æ–™: data: 2024-02-02T10:30:47.000Z å»ºç«‹ RefactorAgent...
...
[10:31:20.500] ğŸ“¨ äº‹ä»¶é¡å‹: event: status
[10:31:20.501] ğŸ“„ è³‡æ–™: data: Task success

============================================================
âœ… ä¸²æµçµæŸï¼å…±æ¥æ”¶ XX è¡Œ
============================================================
```

### å¯èƒ½çš„å•é¡Œï¼š

1. **403/404 éŒ¯èª¤**ï¼šæª¢æŸ¥å°ˆæ¡ˆ ID å’Œæ¬Šé™
2. **503 éŒ¯èª¤**ï¼šå®¹å™¨å¯èƒ½æœªå•Ÿå‹•æˆ– AI Server æœªé‹è¡Œ
3. **é€£ç·šè¶…æ™‚**ï¼šæª¢æŸ¥ Docker ç¶²è·¯è¨­å®š
4. **æ²’æœ‰äº‹ä»¶**ï¼šæª¢æŸ¥ AI Server æ˜¯å¦æ­£ç¢ºè¨˜éŒ„ task_logs

## ğŸ› é™¤éŒ¯æŠ€å·§

### æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ

```bash
# å¾Œç«¯æœƒè¼¸å‡º SSE ç›¸é—œçš„æ—¥èªŒ
[INFO] é–‹å§‹ä¸²æµ AI Server æ—¥èªŒ: refactor-project-xxx, run_id=yyy
[DEBUG] [SSE] event: log
[DEBUG] [SSE] data: ...
[INFO] SSE ä¸²æµçµæŸ: run_id=yyy
```

### ç›´æ¥æ¸¬è©¦ AI Server

```bash
# é€²å…¥å®¹å™¨ç›´æ¥æ¸¬è©¦
docker exec -it refactor-project-<project_id> sh

# æ¸¬è©¦ AI Server æ˜¯å¦é‹è¡Œ
wget -O- http://localhost:8000/health

# æ¸¬è©¦ä»»å‹™åˆ—è¡¨
wget -O- http://localhost:8000/tasks
```

### æ‰‹å‹•æ¸¬è©¦ SSE

```bash
# ä½¿ç”¨ curl æ¸¬è©¦ï¼ˆéœ€è¦å…ˆå–å¾— tokenï¼‰
curl -N \
  -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/projects/PROJECT_ID/agent/runs/RUN_ID/stream
```

## âœ… æˆåŠŸæ¨™æº–

- [ ] èƒ½å¤ æˆåŠŸå»ºç«‹ SSE é€£ç·š
- [ ] èƒ½å¤ æ¥æ”¶åˆ° `event: log` äº‹ä»¶
- [ ] èƒ½å¤ æ¥æ”¶åˆ°æ—¥èªŒå…§å®¹ `data: ...`
- [ ] èƒ½å¤ æ¥æ”¶åˆ° `event: status` å®Œæˆäº‹ä»¶
- [ ] ä¸²æµæ­£å¸¸çµæŸï¼ˆä¸æ˜¯å› ç‚ºéŒ¯èª¤ä¸­æ–·ï¼‰
- [ ] æœ€çµ‚ç‹€æ…‹æŸ¥è©¢é¡¯ç¤º `DONE` æˆ– `FAILED`

## ğŸ“ å›å ±å•é¡Œæ™‚è«‹æä¾›

1. å®Œæ•´çš„æ¸¬è©¦è…³æœ¬è¼¸å‡º
2. å¾Œç«¯ API çš„æ—¥èªŒï¼ˆç‰¹åˆ¥æ˜¯ `[SSE]` é–‹é ­çš„ï¼‰
3. å®¹å™¨ç‹€æ…‹ï¼š`docker ps | grep refactor-project`
4. AI Server å¥åº·æª¢æŸ¥ï¼š`docker exec refactor-project-xxx wget -O- http://localhost:8000/health`
